# ----------------------------------------------------------------------------#

image: python:3.13

# ----------------------------------------------------------------------------#

stages:
  - lint
  - build
  - test
  # - deploy

# ----------------------------------------------------------------------------#

before_script:
  - pip install -r requirements-dev.txt
  - pip install -r requirements.txt

# ----------------------------------------------------------------------------#

include:
  - template: Jobs/Dependency-Scanning.gitlab-ci.yml
  - template: Jobs/SAST.gitlab-ci.yml
  - template: Jobs/Secret-Detection.gitlab-ci.yml

# ----------------------------------------------------------------------------#

isort:
  stage: lint
  interruptible: true
  script:
    - isort --diff --skip-gitignore --line-length 79 enterpriseattack

# ----------------------------------------------------------------------------#

flake8:
  stage: lint
  interruptible: true
  script:
    - flake8 enterpriseattack

# ----------------------------------------------------------------------------#

black:
  stage: lint
  interruptible: true
  script:
    - black -l 79 -S enterpriseattack --diff

# ----------------------------------------------------------------------------#

build:
  stage: build
  interruptible: true
  variables:
    COSIGN_YES: "true"
  id_tokens:
    SIGSTORE_ID_TOKEN:
      aud: sigstore
  before_script:
    - 'export LATEST_VERSION=$(curl https://api.github.com/repos/sigstore/cosign/releases/latest | grep tag_name | cut -d : -f2 | tr -d "v\", ")'
    - curl -O -L "https://github.com/sigstore/cosign/releases/latest/download/cosign_${LATEST_VERSION}_amd64.deb"
    - dpkg -i cosign_${LATEST_VERSION}_amd64.deb
    - pip install -r requirements-dev.txt
  script:
    - python3 setup.py sdist bdist_wheel --universal
    - cosign sign-blob dist/enterpriseattack-*.tar.gz --bundle cosign.bundle
  artifacts:
    paths:
      - dist/*
      - cosign.bundle

# ----------------------------------------------------------------------------#

sast:
  stage: test
  interruptible: true
  script:
    - []

# ----------------------------------------------------------------------------#

coverage:
  stage: test
  interruptible: true
  script:
    - pytest -s -vv --cov=enterpriseattack --cov-report=term --cov-report=term-missing --cov-report=html tests
  coverage: '/TOTAL.*? (100(?:\.0+)?\%\|[1-9]?\d(?:\.\d+)?\%)$/'

# ----------------------------------------------------------------------------#

bandit:
  stage: test
  interruptible: true
  script:
    - bandit .

# ----------------------------------------------------------------------------#

python:3.13:
  stage: test
  image: python:3.13
  script:
    - tox -e py313

python:3.12:
  stage: test
  image: python:3.12
  script:
    - tox -e py312

python:3.11:
  stage: test
  image: python:3.11
  script:
    - tox -e py311

python:3.10:
  stage: test
  image: python:3.10
  script:
    - tox -e py310

python:3.9:
  stage: test
  image: python:3.9
  script:
    - tox -e py39

python:3.8:
  stage: test
  image: python:3.8
  script:
    - tox -e py38

python:3.7:
  stage: test
  image: python:3.7
  script:
    - tox -e py37

# ----------------------------------------------------------------------------#

# deploy:
#   stage: deploy
#   script:
#     - pip install twine
#     - python setup.py sdist bdist_wheel
#     - twine upload dist/* -u $PYPI_USERNAME -p $PYPI_PASSWORD
#   only:
#     - tags
