# ----------------------------------------------------------------------------#

image: python:3.12

# ----------------------------------------------------------------------------#

stages:
  - lint
  - test
  - compatibility
  - deploy

# ----------------------------------------------------------------------------#

include:
  - template: Jobs/Dependency-Scanning.gitlab-ci.yml
  - template: Jobs/SAST.gitlab-ci.yml
  - template: Jobs/Secret-Detection.gitlab-ci.yml

# ----------------------------------------------------------------------------#

commit:
  stage: lint
  image: node:latest
  script:
    - npm install -g @commitlint/cli @commitlint/config-angular
    - git fetch origin $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    - git log --pretty=format:%s $CI_MERGE_REQUEST_DIFF_BASE_SHA..$CI_COMMIT_SHA | commitlint --config .commitlintrc
  only:
    - merge_requests

# ----------------------------------------------------------------------------#

docs:
  stage: lint
  image: node:latest
  script:
    - npm install -g markdownlint-cli
    - markdownlint **/*.md
  rules:
    - when: always

# ----------------------------------------------------------------------------#

flake8:
  stage: lint
  interruptible: true
  script:
    - make install
    - tox -e flake8

# ----------------------------------------------------------------------------#

sast:
  stage: test
  interruptible: true
  script:
    - []

# ----------------------------------------------------------------------------#

pytest:
  stage: test
  interruptible: true
  script:
    - make install
    - pytest tests

# ----------------------------------------------------------------------------#

coverage:
  stage: test
  interruptible: true
  script:
    - make install
    - pytest --cov=enterpriseattack --cov-report term-missing
  coverage: '/TOTAL.*\s+(\d+\%)/'

# ----------------------------------------------------------------------------#

py312:
  stage: compatibility
  image: python:3.12
  script:
    - pip install -r dev_requirements.txt
    - tox -e py312 --parallel auto

py311:
  stage: compatibility
  image: python:3.11
  script:
    - pip install -r dev_requirements.txt
    - tox -e py311 --parallel auto

py310:
  stage: compatibility
  image: python:3.10
  script:
    - pip install -r dev_requirements.txt
    - tox -e py310 --parallel auto

py39:
  stage: compatibility
  image: python:3.9
  script:
    - pip install -r dev_requirements.txt
    - tox -e py39 --parallel auto

py38:
  stage: compatibility
  image: python:3.8
  script:
    - pip install -r dev_requirements.txt
    - tox -e py38 --parallel auto

py37:
  stage: compatibility
  image: python:3.7
  script:
    - pip install -r dev_requirements.txt
    - tox -e py37 --parallel auto

# ----------------------------------------------------------------------------#

deploy:
  stage: deploy
  script:
    - pip install twine
    - python3 setup.py sdist bdist_wheel --universal
    - twine upload dist/*
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - setup.py
        - enterpriseattack/*
