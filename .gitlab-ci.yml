# ----------------------------------------------------------------------------#

image: python:latest

# ----------------------------------------------------------------------------#

stages:
  - lint
  - test
  - deploy

# ----------------------------------------------------------------------------#

include:
  - template: Jobs/Dependency-Scanning.gitlab-ci.yml
  - template: Jobs/SAST.gitlab-ci.yml
  - template: Jobs/Secret-Detection.gitlab-ci.yml

# ----------------------------------------------------------------------------#

lint:
  stage: lint
  interruptible: true
  script:
    - pip install -r dev_requirements.txt
    - flake8 .

# ----------------------------------------------------------------------------#

sast:
  stage: test
  interruptible: true
  script:
    - []

# ----------------------------------------------------------------------------#

unit:
  stage: test
  interruptible: true
  script:
    - pip install -r dev_requirements.txt
    - pip install -r requirements.txt
    - pytest tests

# ----------------------------------------------------------------------------#

coverage:
  stage: test
  interruptible: true
  script:
    - pip install -r dev_requirements.txt
    - pip install -r requirements.txt
    - pytest --cov=enterpriseattack --cov-report term-missing
  coverage: '/TOTAL.*\s+(\d+\%)/'

# ----------------------------------------------------------------------------#

python:3.12:
  stage: test
  image: python:3.12
  script:
    - pip install -r dev_requirements.txt
    - tox -e py312 --parallel auto

python:3.11:
  stage: test
  image: python:3.11
  script:
    - pip install -r dev_requirements.txt
    - tox -e py311 --parallel auto

python:3.10:
  stage: test
  image: python:3.10
  script:
    - pip install -r dev_requirements.txt
    - tox -e py310 --parallel auto

python:3.9:
  stage: test
  image: python:3.9
  script:
    - pip install -r dev_requirements.txt
    - tox -e py39 --parallel auto

python:3.8:
  stage: test
  image: python:3.8
  script:
    - pip install -r dev_requirements.txt
    - tox -e py38 --parallel auto

python:3.7:
  stage: test
  image: python:3.7
  script:
    - pip install -r dev_requirements.txt
    - tox -e py37 --parallel auto
